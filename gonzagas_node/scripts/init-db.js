require('dotenv').config();
const mysql = require('mysql2/promise');

// Carrega as vari√°veis de ambiente
console.log('üîç Vari√°veis de ambiente carregadas:');
console.log(`DB_HOST: ${process.env.DB_HOST}`);
console.log(`DB_ROOT_USER: ${process.env.DB_ROOT_USER}`);
console.log(`DB_USER: ${process.env.DB_USER}`);
console.log(`DB_NAME: ${process.env.DB_NAME}`);

// Configura√ß√£o do banco de dados raiz para criar o banco de dados se n√£o existir
const rootConfig = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_ROOT_USER || 'root',
  password: process.env.DB_ROOT_PASSWORD || '',
  multipleStatements: true
};

// Configura√ß√£o do banco de dados da aplica√ß√£o
const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'gonzagas_user',
  password: process.env.DB_PASSWORD || 'gonzagas_pass',
  database: process.env.DB_NAME || 'gonzagas_db',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  charset: 'utf8mb4',
  timezone: 'Z'
};

console.log('üîë Configura√ß√£o do banco de dados raiz:', {
  host: rootConfig.host,
  user: rootConfig.user,
  hasPassword: !!rootConfig.password
});

// Fun√ß√£o para tentar conectar ao MySQL com as credenciais fornecidas
async function tryConnection(config) {
  let connection;
  try {
    console.log('üîë Tentando conectar com as credenciais:', {
      host: config.host,
      user: config.user,
      hasPassword: !!config.password
    });
    
    const connectionConfig = {
      host: config.host,
      user: config.user,
      password: config.password || undefined, // Evita enviar senha vazia
      multipleStatements: true,
      waitForConnections: true,
      connectionLimit: 10,
      queueLimit: 0,
      connectTimeout: 10000 // 10 segundos de timeout
    };
    
    console.log('üîå Configura√ß√£o de conex√£o:', JSON.stringify(connectionConfig, null, 2));
    
    // Cria uma nova conex√£o
    connection = await mysql.createConnection(connectionConfig);
    console.log('üîå Conex√£o criada, estado:', connection.state);
    
    // Verifica se a conex√£o est√° ativa
    console.log('üîç Verificando estado da conex√£o...');
    const [rows] = await connection.query('SELECT 1 as test');
    console.log('‚úÖ Teste de consulta bem-sucedido:', rows);
    
    return { success: true, connection };
  } catch (error) {
    console.error('‚ùå Erro na conex√£o:', error);
    if (connection) {
      console.log('üîå Estado da conex√£o no erro:', connection.state);
      try {
        await connection.end();
      } catch (endError) {
        console.error('‚ùå Erro ao fechar conex√£o:', endError);
      }
    }
    return { success: false, error };
  }
}

// Cria uma pool de conex√µes para o banco de dados da aplica√ß√£o
const pool = mysql.createPool(dbConfig);

// Fun√ß√£o para testar a conex√£o com o banco de dados
async function testConnection() {
  let connection;
  try {
    connection = await pool.getConnection();
    await connection.ping();
    return true;
  } catch (error) {
    console.error('Erro de conex√£o:', error.message);
    return false;
  } finally {
    if (connection) await connection.release();
  }
}

// Fun√ß√£o para criar o banco de dados e o usu√°rio se n√£o existirem
async function setupDatabase() {
  let rootConn;
  
  try {
    console.log('üîç Conectando ao servidor MySQL...');
    
    // Tenta conectar com as credenciais fornecidas
    const connectionResult = await tryConnection(rootConfig);
    
    if (!connectionResult.success) {
      console.error('‚ùå Falha na autentica√ß√£o. Verifique as credenciais do MySQL no arquivo .env');
      console.error('Certifique-se de que as vari√°veis DB_ROOT_USER e DB_ROOT_PASSWORD est√£o configuradas corretamente.');
      return false;
    }
    
    rootConn = connectionResult.connection;

    // Executa cada comando separadamente para garantir que a conex√£o n√£o seja fechada
    try {
      // Cria o banco de dados se n√£o existir
      console.log('üîÑ Criando banco de dados...');
      await rootConn.query(`CREATE DATABASE IF NOT EXISTS \`${dbConfig.database}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`);
      
      // Remove o usu√°rio se existir
      console.log('üîÑ Configurando usu√°rio...');
      try {
        await rootConn.query(`DROP USER IF EXISTS '${dbConfig.user}'@'%'`);
      } catch (dropError) {
        console.log('‚ÑπÔ∏è  Usu√°rio n√£o existia, continuando...');
      }
      
      // Cria o usu√°rio
      await rootConn.query(`CREATE USER '${dbConfig.user}'@'%' IDENTIFIED BY ?`, [dbConfig.password]);
      
      // Concede permiss√µes
      await rootConn.query(`GRANT ALL PRIVILEGES ON \`${dbConfig.database}\`.* TO '${dbConfig.user}'@'%'`);
      
      // Atualiza as permiss√µes
      await rootConn.query('FLUSH PRIVILEGES');

      console.log('‚úÖ Banco de dados e usu√°rio configurados com sucesso!');
      return true;
    } catch (queryError) {
      console.error('‚ùå Erro ao executar consulta SQL:', queryError.message);
      return false;
    }
  } catch (error) {
    console.error('‚ùå Erro ao configurar o banco de dados:', error.message);
    return false;
  } finally {
    if (rootConn) {
      try {
        await rootConn.end();
      } catch (endError) {
        console.error('‚ùå Erro ao fechar a conex√£o:', endError.message);
      }
    }
  }
}

// Fun√ß√£o para inicializar as tabelas do banco de dados
async function initializeDatabase() {
  let connection;
  try {
    console.log('üîÑ Conectando ao banco de dados...');
    connection = await pool.getConnection();
    
    // Habilita chaves estrangeiras
    await connection.query('SET FOREIGN_KEY_CHECKS = 0');
    
    // Lista de tabelas para remo√ß√£o (em ordem reversa para evitar problemas de chave estrangeira)
    const tablesToDrop = [
      'inventory_movements',
      'product_sales',
      'product_purchases',
      'product_pricing',
      'product_images',
      'products',
      'customers',
      'suppliers',
      'product_families'
    ];
    
    // Remove as tabelas existentes
    for (const table of tablesToDrop) {
      try {
        await connection.query(`DROP TABLE IF EXISTS \`${table}\``);
      } catch (error) {
        console.warn(`‚ö†Ô∏è  Aviso ao remover tabela ${table}:`, error.message);
      }
    }
    
    // Cria as tabelas
    console.log('üîÑ Criando tabelas...');
    
    // Tabela product_families
    await connection.query(`
      CREATE TABLE IF NOT EXISTS product_families (
        id INT AUTO_INCREMENT PRIMARY KEY,
        code VARCHAR(50) UNIQUE NOT NULL,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela suppliers
    await connection.query(`
      CREATE TABLE IF NOT EXISTS suppliers (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        contact_person VARCHAR(100),
        email VARCHAR(100),
        phone VARCHAR(20),
        tax_number VARCHAR(20) COMMENT 'NIF',
        address TEXT,
        city VARCHAR(100),
        postal_code VARCHAR(20),
        country VARCHAR(100) DEFAULT 'Portugal',
        payment_terms TEXT,
        notes TEXT,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela customers
    await connection.query(`
      CREATE TABLE IF NOT EXISTS customers (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        email VARCHAR(100) UNIQUE,
        phone VARCHAR(20),
        tax_number VARCHAR(20) COMMENT 'NIF',
        address TEXT,
        city VARCHAR(100),
        postal_code VARCHAR(20),
        country VARCHAR(100) DEFAULT 'Portugal',
        notes TEXT,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        last_login TIMESTAMP NULL,
        login_attempts INT DEFAULT 0,
        password_hash VARCHAR(255),
        password_reset_token VARCHAR(100),
        password_reset_expires TIMESTAMP NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela products
    await connection.query(`
      CREATE TABLE IF NOT EXISTS products (
        id INT AUTO_INCREMENT PRIMARY KEY,
        reference VARCHAR(50) UNIQUE NOT NULL,
        barcode VARCHAR(50),
        family_id INT,
        name VARCHAR(200) NOT NULL,
        description TEXT,
        weight DECIMAL(10,3) DEFAULT 0,
        weight_unit ENUM('g', 'kg') DEFAULT 'g',
        dimensions VARCHAR(50) COMMENT 'LxAxP em mm',
        style VARCHAR(100),
        material VARCHAR(100),
        notes TEXT,
        is_active BOOLEAN DEFAULT TRUE,
        min_stock_level INT DEFAULT 0,
        max_stock_level INT DEFAULT 0,
        location VARCHAR(50) COMMENT 'Localiza√ß√£o no armaz√©m',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (family_id) REFERENCES product_families(id) ON DELETE SET NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela product_images
    await connection.query(`
      CREATE TABLE IF NOT EXISTS product_images (
        id INT AUTO_INCREMENT PRIMARY KEY,
        product_id INT NOT NULL,
        image_path VARCHAR(255) NOT NULL,
        is_primary BOOLEAN DEFAULT FALSE,
        sort_order INT DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela product_pricing
    await connection.query(`
      CREATE TABLE IF NOT EXISTS product_pricing (
        id INT AUTO_INCREMENT PRIMARY KEY,
        product_id INT NOT NULL,
        pvp_price DECIMAL(10,2) NOT NULL COMMENT 'Pre√ßo de venda ao p√∫blico',
        wholesale_price DECIMAL(10,2) COMMENT 'Pre√ßo de atacado',
        special_price DECIMAL(10,2) COMMENT 'Pre√ßo promocional',
        special_price_start DATE,
        special_price_end DATE,
        cost_price DECIMAL(10,2) COMMENT 'Custo m√©dio',
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela product_purchases
    await connection.query(`
      CREATE TABLE IF NOT EXISTS product_purchases (
        id INT AUTO_INCREMENT PRIMARY KEY,
        product_id INT NOT NULL,
        supplier_id INT,
        purchase_price DECIMAL(10,2) NOT NULL,
        quantity INT NOT NULL,
        purchase_date DATE NOT NULL,
        batch_number VARCHAR(50),
        notes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
        FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE SET NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela product_sales
    await connection.query(`
      CREATE TABLE IF NOT EXISTS product_sales (
        id INT AUTO_INCREMENT PRIMARY KEY,
        product_id INT NOT NULL,
        customer_id INT,
        sale_price DECIMAL(10,2) NOT NULL,
        quantity INT NOT NULL,
        sale_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        discount_percent DECIMAL(5,2) DEFAULT 0,
        discount_amount DECIMAL(10,2) DEFAULT 0,
        notes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
        FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Tabela inventory_movements
    await connection.query(`
      CREATE TABLE IF NOT EXISTS inventory_movements (
        id INT AUTO_INCREMENT PRIMARY KEY,
        product_id INT NOT NULL,
        movement_type ENUM('purchase', 'sale', 'adjustment', 'return', 'loss') NOT NULL,
        quantity DECIMAL(10,3) NOT NULL COMMENT 'Pode ser fracionado para itens que usam casas decimais',
        reference_id INT COMMENT 'ID da transa√ß√£o relacionada',
        reference_type VARCHAR(50) COMMENT 'Tipo de transa√ß√£o relacionada',
        notes TEXT,
        created_by INT COMMENT 'ID do usu√°rio que realizou o movimento',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    `);
    
    // Habilita novamente as verifica√ß√µes de chave estrangeira
    await connection.query('SET FOREIGN_KEY_CHECKS = 1');
    
    console.log('‚úÖ Tabelas criadas com sucesso!');
    return true;
  } catch (error) {
    console.error('‚ùå Erro ao criar as tabelas:', error);
    throw error;
  } finally {
    if (connection) await connection.release();
  }
}

// Fun√ß√£o principal
async function main() {
  try {
    // Configura o banco de dados e o usu√°rio
    const dbSetup = await setupDatabase();
    if (!dbSetup) {
      console.error('‚ùå Falha na configura√ß√£o inicial do banco de dados.');
      process.exit(1);
    }
    
    // Inicializa o banco de dados
    console.log('üîÑ Inicializando as tabelas do banco de dados...');
    await initializeDatabase();
    
    // Testa a conex√£o
    console.log('üîç Testando conex√£o com o banco de dados...');
    const isConnected = await testConnection();
    
    if (!isConnected) {
      throw new Error('Falha ao conectar ao banco de dados ap√≥s a inicializa√ß√£o');
    }
    
    console.log('‚úÖ Conex√£o com o banco de dados estabelecida com sucesso!');
    console.log('‚ú® Banco de dados inicializado com sucesso!');
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Erro durante a inicializa√ß√£o do banco de dados:', error.message);
    process.exit(1);
  } finally {
    await pool.end();
  }
}

// Executa a inicializa√ß√£o
main().catch(error => {
  console.error('‚ùå Erro n√£o tratado:', error);
  process.exit(1);
});
